<!DOCTYPE HTML>
<html lang="en">
<link rel="stylesheet" href="main.css" type="text/css" />

    <head>
        <title>Hometown</title>
        <script src="./javascript/canvas.js" defer></script>
        <script src="./javascript/prompt.js" defer></script>
    </head>

    <body>
        
        <!--Main Page screen-->
        <div id="mainPage">
            <div align="center">

                <h1>
                    Welcome to Pictionary Telephone
                </h1>
        
            </div>

            <div align="center">

                <h2>
                    If you are on a smartphone, please tilt your phone horizontally for the best results
                </h2>
        
            </div>
            <div align="center">
    
                <h2>
                    Start a new game?
                </h2>
        
                <button class="new_button" onclick="createButtonClicked()">
                    Make new game!
                </button>
    
            </div>
    
            <div align="center">
    
                <h2>
                    Join an existing game?
                </h2>
    
                <button class="join_button" id="mainJoinButton" onclick="mainJoinButtonClicked()">
                    Join existing game!
                </button>
        
            </div>
    
            <div class="gamedescrip">
               
                <h2 align="center">
                    Description:
                </h2>
    
                <p class="description">
                    Welcome to Pictionary Telephone. Pictionary Telephone is a drawing version of the classic game, Telephone. 
                    The game will consist of multiple rounds that are either prompt rounds or 
                    drawing rounds. In the 
                    initial prompt round, players will have to come up with a prompt. Then it will be a drawing round
                    Player must draw a picture that they 
                    believe best represents the random prompt that they were given. Similarly,
                     the following round 
                    will involve each player getting a random drawn picture they will have to 
                    guess what the initial prompt was. This process repeats until all the rounds
                    have concluded. Then, there will be a time at the end to collectively view the
                    journey that each prompt went through 
    
                </p>
        
            </div>
        </div>

        <!--Transition join screen-->
        <div id="joinPage" style="display:none">
            <div align="center">

                <h1>
                    Join a new game!
                </h1>
        
                
            </div>
            <div align="center">
    
                <h2>
                    Enter game code:
                </h2>
        
                <input type="text" id="lobbyIDInput" size = 20 maxlength=35 value="">
    
    
            </div>
    
            <div align="center">
    
                <h2>
                    Enter your name:
                </h2>
    
                <input type="text" id="usernameInput" size = 20 maxlength=35 value="">
        
            </div>
            <br></br>
        
            <div align="center">
    
                <button class="join_button" id="joinJoinButton" onclick="joinJoinButtonClicked()">
                    Join!
                </button>
            
            </div>
        </div>

        <!--Main Screen Lobby screen-->
        <div id="lobbyPage" style="display:none">
            <!-- <svg class="promptTimer"  viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <g class="promptTimerCircle">
                  <circle  class="promptTimepath" cx="50" cy="50" r="45" />
                </g>
            </svg> -->
            <!-- <div class="timerBox" align="center"> -->
            <div class="timerLabel1" id="timerLabel1" >
            </div>
            
            
            <div align="center">

                <h1>
                    Welcome to the Game Lobby!
                </h1>
        
            </div>
            <div class = "gamecodetext">
    
                <h2>
                    Game Code
                </h2>
            
            </div>
    
            <div class = "gamecodebox">
    
                <div class="boxed" id="lobbyIDDisplay">
                    Insert Game Code Here from Server
                  </div>
    
                
            </div>
    
            <div class = "start_button_location"  onclick="startGameButtonClicked()">
                
                <button class="start_button">
                    Start Game!
                </button>
    
            </div>
                
           
    
            <div class = "waitingtext">
               
                <h2>Waiting Room:</h2>
            
            </div>
            
            
    
            <div class="waitingbox" id="playerList">
                    Names from the server that are already in the game
            </div>
        </div>


        <!--Player Lobby screen-->
        <div id="playerLobbyPage" style="display:none">
            <div align="center">

                <h1>
                    Welcome to the Game Lobby!
                </h1>
        
            </div>
    
            <div class = "playerWaitingText">
               
                <h2>Waiting Room:</h2>
            
            </div>
            
    
            <div class="lobbybox" id="playerListPlayer">
                
            </div>
        </div>
    

        <!--Prompt screen-->
        <div id="promptPage" style="display:none">
         
            <div align="center">
                <h2>
                    <img id="canvasForPrompt" alt="Text for giving prompt inspiration"
                    width="1000" height="500">
                    </img>
                </h2>
            </div>

            <textarea name="text" id="prompt" rows="5"  wrap="soft" placeholder="Enter Prompt Here"> </textarea>
            <button class="enter_button" id="submitPrompt" onclick="enterPromptButtonClicked()">Enter</button>
        </div>


        <!--Waiting for next round screen-->
        <div id="waitingNextRoundPage" style="display:none">
            <!-- <svg class="promptTimer"  viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <g class="promptTimerCircle">
                  <circle class="promptTimepath" cx="50" cy="50" r="45" />
                </g>
            </svg>
            <span class="timerLablel" onload="TimeLeft()" align = "center">
            </span> -->
            

            <div align="center">

                <h1>
                    Waiting for Players to finish
                </h1>
        
                
            </div>
    
            <div align = "center">
    
                <p>
                    Finished Players
                </p>
                <div class="lobbybox" id="finishedPlayers">
                    Names from the server that are already done
                </div>
    
            </div>
            <br>
            </br>
            <div align = "center">

                <p>
                    Unfinished Players
                </p>
                <div class="lobbybox" id="unfinishedPlayers">
                    Names from the server are not done
                </div>
    
            </div>
            
        </div>


        <!--Canvas screen-->
        <div id="canvasPage" style="display:none">
            <div align="center">
                <h1>
                    Name of Game
                </h1>
            </div>
            <div align="center">
                <h2>
                    Draw the Prompt below!
                </h2>
            </div>

            <div align="center">
                <h2>
                    <div class="text" id="promptToDraw">
                        Prompt
                    </div>
                </h2>
            </div>

          <!--Set up canvas & quick version of setting up fabric-->
            <div align="center">

                <canvas id="canvas" width="600%" height="400%" style="border:1px solid #000000;"></canvas>
                <script src="https://cdn.jsdelivr.net/npm/fabric"></script>
                
                <label for="colorpicker" style="color:white">Change Color:</label>
                <input type="color" id="colorpicker" value="#0000ff" oninput="changeColor()">
                
                <label for="sizepicker" style="color:white">Change Brush Size:</label>
                <input type="number" id="sizepicker" min="1" value="5" oninput="changeSize()">
                
                <script src="javascript/canvas.js"></script>

            </div>  
                    

            <div align="center">
                <button class="enter_button" id="submitCanvas" onclick="enterCanvasButtonClicked()">I'm done drawing!</button>
            </div>
        </div>

        
        <!--Main canvas page-->
        <div id="mainCanvasPage" style="display:none">
            <div align="center">

                <h1>
                    Do you draw like Picasso or a 4-year old???
                </h1>
        
                
            </div>
    
           
    
            <div align = "center">
    
                <h2>
    
                    Time Remaining: 
    
                    
    
                </h2> 
                <div class="timerLabel3" id="timerLabel3" >
                    1m:0s
                </div>
    
                
            </div>
            <br>
            </br>
            <div align = "center">
    
                <div class="lobbybox" id="mainCanvasFinishedPlayers">
                    Cool People with beautiful drawings:
                </div>
    
            </div>
            <br>
            </br>
            <div align = "center">
    
                <div class="lobbybox" id="mainCanvasUnfinishedPlayers">
                    People who draw slow:
                </div>
    
            </div> 
        </div>

              
        <!--Main prompt page-->
        <div id="mainPromptPage" style="display:none">
            
            <div align="center">

                <h1>
                    Who is going to come up with the best prompt???
                </h1>
                
            </div>
    
            <div align = "center">
    
                <h2>
    
                    Time Remaining: 
    
                </h2> 
                <div class="timerLabel2" id="timerLabel2" >
                    1m:0s
                </div>
       
            </div>
            <br>
            </br>
            <div align = "center">
    
                <div class="lobbybox" id="mainPromptFinishedPlayers">
                    Cool People with great prompts:<br>
                </div>
    
            </div>
            <br>
            </br>
            <div align = "center">
    
                <div class="lobbybox" id="mainPromptUnfinishedPlayers">
                    People who don't know what a prompt is:<br>
                </div>
    
            </div>
        </div>


        <!--End Game Choose Book-->
        <div id="endGameChoose" style="display:none">
            <div align="center">

                <h1>
                    Congratulations! Here are the results
                </h1>
                
                <h2>
                    Click on a book to view the contents
                </h2>
        
            </div>
           
            <table align="center">
                <tr>
                    <td style="padding: 20px;"><div class="box" id="book1" onclick="book1Clicked()"></div></td>
                    <td style="padding: 20px;"><div class="box" id="book2" onclick="book2Clicked()"></div></td>
                    <td style="padding: 20px;"><div class="box" id="book3" onclick="book3Clicked()"></div></td>
                </tr>
                <tr>
                    <td style="padding: 20px;"><div class="box" id="book4" onclick="book4Clicked()"></div></td>
                    <td style="padding: 20px;"><div class="box" id="book5" onclick="book5Clicked()"></div></td>
                    <td style="padding: 20px;"><div class="box" id="book6" onclick="book6Clicked()"></div></td>
                </tr>
                <tr>
                    <td style="padding: 20px;"><div class="box" id="book7" onclick="book7Clicked()"></div></td>
                    <td style="padding: 20px;"><div class="box" id="book8" onclick="book8Clicked()"></div></td>
                    <td style="padding: 20px;"><div class="box" id="book9" onclick="book9Clicked()"></div></td>
                </tr>
            </table>
              
        </div>


         <!--End Game results-->
        <div id="endGameResults" style="display:none">
            <div align="center">

                <h1>
                    Here are the contents from this book
                </h1>

                <img id="endGameCanvas"
                    width="1000" height="500">
                    </img>

                <h2>
                    Did the prompt stay the same? Or is is completely wrong?
                </h2>
        
            </div>
           
            <div class="container">
                <button class="arrow-button left">&lt;</button>
                <div class="box2">
                  <!-- content for the big box goes here -->
                </div>
                <button class="arrow-button right">&gt;</button>
              </div>
              
        </div>




        <script src="/socket.io/socket.io.js"></script>

        <script>
            const socket = io();
            //var startTimer;
            
            /* HTML elements */


            
            const screenViews = {
              mainPage: document.getElementById("mainPage"),
              joinPage: document.getElementById("joinPage"),
              lobbyPage: document.getElementById("lobbyPage"),
              playerLobbyPage: document.getElementById("playerLobbyPage"),
              promptPage: document.getElementById("promptPage"),
              waitingNextRoundPage: document.getElementById("waitingNextRoundPage"),
              canvasPage: document.getElementById("canvasPage"),
              mainCanvasPage: document.getElementById("mainCanvasPage"),
              mainPromptPage: document.getElementById("mainPromptPage"),
              endGameChoose: document.getElementById("endGameChoose"),
              endGameResults: document.getElementById("endGameResults")
            };

            const lobbyIDInput = document.getElementById("lobbyIDInput");
            const usernameInput = document.getElementById("usernameInput");
            const lobbyIDDisplay = document.getElementById("lobbyIDDisplay");

            const playerList = document.getElementById("playerList");
            const playerListPlayer = document.getElementById("playerListPlayer");
            const finishedPlayers = document.getElementById("finishedPlayers");
            const unfinishedPlayers = document.getElementById("unfinishedPlayers");

            const mainPromptFinishedPlayers = document.getElementById("mainPromptFinishedPlayers");
            const mainPromptUnfinishedPlayers = document.getElementById("mainPromptUnfinishedPlayers");
            const mainCanvasFinishedPlayers = document.getElementById("mainCanvasFinishedPlayers");
            const mainCanvasUnfinishedPlayers = document.getElementById("mainCanvasUnfinishedPlayers");

            const promptValue = document.getElementById("prompt").value;
            const promptToDraw = document.getElementById("promptToDraw");
            const canvasDrawing = document.getElementById('canvas');
            const canvasForPrompt = document.getElementById('canvasForPrompt');

            const endGameCanvas = document.getElementById('endGameCanvas');
            
            
            /* Utility Functions */
            
            function switchView(newViewName){
              for (let [viewName, view] of Object.entries(screenViews)) {
                if (viewName === newViewName) {
                  view.style.display = 'block';
                } 
                else {
                  view.style.display = 'none';
                }
              }
            }
            
            
            /* Game Functionality */
            
            /* Create a new game. Emit newGame event. */
            function createButtonClicked() {
                socket.emit('createClicked', socket.id);
            }
            
            
            /* The join button was clicked on the initial main screen */
            function mainJoinButtonClicked() {
                switchView("joinPage");
            }

            /* The join button was clicked after entering the game code and name of player */
            function joinJoinButtonClicked() {
                const lobbyIDInput = document.getElementById("lobbyIDInput");
                const usernameInput = document.getElementById("usernameInput");
                
                socket.emit("joinClicked", usernameInput.value, lobbyIDInput.value);
            }

            // The start game button was clicked
            function startGameButtonClicked() {

                const lobbyIDInput = document.getElementById("lobbyIDInput");
                socket.emit("startGameClicked", socket.id);
            }

            // The enter prompt button was clicked
            function enterPromptButtonClicked() {
                console.log("ptrue");
                const lobbyIDInput = document.getElementById("lobbyIDInput");
                const usernameInput = document.getElementById("usernameInput");
                const promptValue = document.getElementById("prompt").value;
                socket.emit("promptEntered", usernameInput.value, lobbyIDInput.value, promptValue);
            }

            // The enter canvas button was clicked
            function enterCanvasButtonClicked() {
                const lobbyIDInput = document.getElementById("lobbyIDInput");
                const usernameInput = document.getElementById("usernameInput");
                const canvasDrawing = document.getElementById('canvas');
                const savedCanvas = canvasDrawing.toDataURL('png');
                socket.emit("canvasEntered", usernameInput.value, lobbyIDInput.value, savedCanvas);
            }
            

            /* End Game Book Buttons */

            function book1Clicked(){
                switchView("endGameResults");
            }

            function book2Clicked(){
                switchView("endGameResults");
            }

            function book3Clicked(){
                switchView("endGameResults");
            }

            function book4Clicked(){
                switchView("endGameResults");
            }

            function book5Clicked(){
                switchView("endGameResults");
            }

            function book6Clicked(){
                switchView("endGameResults");
            }

            function book7Clicked(){
                switchView("endGameResults");
            }

            function book8Clicked(){
                switchView("endGameResults");
            }

            function book9Clicked(){
                switchView("endGameResults");
            }


            /* Socket Functionality */

            socket.on("roomCreated", function(lobbyID) {
                switchView("lobbyPage");

                lobbyIDDisplay.innerHTML = lobbyID;
            });


            socket.on("addPlayerToWaitingList", function(players) {
                playerUsernames = players.map((player) => player.username);
                playerList.innerHTML = playerUsernames.join('<br>');
                playerListPlayer.innerHTML = playerUsernames.join('<br>');
            });


            socket.on("playerToWaitingRoom", function() {
                switchView("playerLobbyPage"); //Will be a different page
            });


            socket.on("addPlayerToFinishedList", function(finishedUsernames, allUsernames){
                finishedPlayers.innerHTML = finishedUsernames.join('<br>'); //Might want to change this to appending a child, otherwise it will replace
                unfinishedUsernames = allUsernames.filter(
                function(i) {
                    return this.indexOf(i) < 0;
                },
                finishedUsernames
                );
                unfinishedPlayers.innerHTML = unfinishedUsernames.join('<br>');
            });


            socket.on("mainPromptFinishedList", function(finishedUsernames, allUsernames){
                mainPromptFinishedPlayers.innerHTML = "Cool People with great prompts:<br>" + finishedUsernames.join('<br>');
                unfinishedUsernames = allUsernames.filter(
                function(i) {
                    return this.indexOf(i) < 0;
                },
                finishedUsernames
                );
                mainPromptUnfinishedPlayers.innerHTML = "People who don't know what a prompt is:<br>" + unfinishedUsernames.join('<br>');
            });


            socket.on("mainCanvasFinishedList", function(finishedUsernames, allUsernames){
                mainCanvasFinishedPlayers.innerHTML = "Cool People with beautiful drawings:<br>" + finishedUsernames.join('<br>');
                unfinishedUsernames = allUsernames.filter(
                function(i) {
                    return this.indexOf(i) < 0;
                },
                finishedUsernames
                );
                mainCanvasUnfinishedPlayers.innerHTML = "People who draw slow:<br>" + unfinishedUsernames.join('<br>');
            });


            socket.on("playerToPrompt", function() {
                document.getElementById("prompt").value = "";
                switchView("promptPage");
            });


            socket.on("mainToPrompt", function() {
                mainPromptFinishedPlayers.innerHTML = "Cool People with great prompts:<br>";
                mainPromptUnfinishedPlayers.innerHTML = "People who don't know what a prompt is:<br>";
                switchView("mainPromptPage");
            });

            socket.on("displayPrompt", function(game) {
                for(let j = 0; j < game.numPlayers; j++){
                    if (game.players[j].socketID == socket.id){
                        promptToDraw.innerHTML = game.players[j].currentBook.pages[game.currRound-1].stringInput;
                        break;
                    }
                }
            });

            socket.on("displayCanvas", function(game) {
                for(let j = 0; j < game.numPlayers; j++){
                    if (game.players[j].socketID == socket.id){
                        canvasForPrompt.src = game.players[j].currentBook.pages[game.currRound-1].stringInput;
                        break;
                    }
                }
            });

            //how do we want to call this?
            socket.on("displayEndGameCanvas", function(game) {
                for(let j = 0; j < game.numPlayers; j++){
                    if (game.players[j].socketID == socket.id){
                        endGameCanvas.src = game.players[j].currentBook.pages[game.currRound-1].stringInput;
                        break;
                    }
                }
            });

            socket.on("playerToWaitingNextRound", function() {
                switchView("waitingNextRoundPage");
            });

            socket.on("playerToCanvas", function() {
                // startTimer = true;
                clearCanvas();
                switchView("canvasPage");
            });

            socket.on("mainToCanvas", function() {
                mainCanvasFinishedPlayers.innerHTML = "Cool People with beautiful drawings:<br>";
                mainCanvasUnfinishedPlayers.innerHTML = "People who draw slow:<br>";
                switchView("mainCanvasPage");
            });

            socket.on("playersToEndgame", function() {
                switchView("mainPage");
            });

            socket.on("mainToEndgame", function() {
                switchView("endGameChoose");
            });

            // change the status of the timer
            socket.on("timeStatus", function(game) {
                //console.log("here2");
                //startTimer = game.timerStatus;
                
            });
            
            socket.on("timerStart", function(game) {
                //console.log("here");
                var startDate = new Date();
                document.getElementById("timerLabel1").innerHTML = 1 + "m " + 0 + "s ";
                
                if (game.timerStatus == true){
                    //startDate = new Date();
                    startDate.setMinutes(startDate.getMinutes() + 1);
                    var x = setInterval(function() {

                        // today's date and time
                        var nowDate = new Date().getTime();

                        // timeleft
                        var timeLeft = startDate - nowDate;

                        // calculate time in minutes and secounds
                        // var days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                        // var hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        var minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                        var seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                        // display the results
                        document.getElementById("timerLabel1").innerHTML = minutes + "m " + seconds + "s ";
                        document.getElementById("timerLabel2").innerHTML = minutes + "m " + seconds + "s ";
                        document.getElementById("timerLabel3").innerHTML = minutes + "m " + seconds + "s ";
                        //All entries are subimited when time =0
                        if (timeLeft < 0) {
                            clearInterval(x);
                            document.getElementById("timerLabel1").innerHTML = "EXPIRED";
                            document.getElementById("timerLabel2").innerHTML = "EXPIRED";
                            document.getElementById("timerLabel3").innerHTML = "EXPIRED";

                            

                            //figure out how to find what pages are displaying
                            //figure out how to subimt all responses forcefully
                            if (promptPage.style.display == 'none'){
                                //document.getElementById('submitPrompt').click();
                                enterPromptButtonClicked();
                            }
                            if (canvasPage.style.display == 'none'){
                                //document.getElementById('submitCanvas').click();
                                enterCanvasButtonClicked();
                            }   

                        }
                    }, 1000);
                } else {
                    startDate = new Date();
                    startDate.setMinutes(startDate.getMinutes() + 1);
                    document.getElementById("timerLabel1").innerHTML = 1 + "m " + 0 + "s ";
                    document.getElementById("timerLabel2").innerHTML = 1 + "m " + 0 + "s ";
                    document.getElementById("timerLabel3").innerHTML = 1 + "m " + 0 + "s ";
                }
            });
            
            //original timer loc
            

        </script>
    </body>
</html>
